generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/** ───────── Departments ───────── */
model Department {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  shortCode   String?  @unique @db.VarChar(10)
  location    String?  @db.VarChar(100)
  description String?  @db.VarChar(500)
  status      Boolean  @default(true)
  timeFrom    String?
  timeTo      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  procedures         Procedure[]
  doctorLinks        DoctorDepartment[]
  DoctorProcedureFee DoctorProcedureFee[]
  medicalHistory     MedicalHistory[] @relation("MedicalHistoryDepartment")

  @@index([name])
}

/** ───────── Procedures ───────── */
model Procedure {
  id           Int        @id @default(autoincrement())
  status       Boolean    @default(true)
  name         String     @db.VarChar(100)
  shortCode    String?    @db.VarChar(10)
  description  String?    @db.VarChar(500)
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  feeLinks        DoctorProcedureFee[]
  medicalHistory  MedicalHistory[] @relation("MedicalHistoryProcedure")

  @@unique([departmentId, name])
  @@index([departmentId])
  @@index([name])
}

/** ───────── Doctor ───────── */
model Doctor {
  id     Int     @id @default(autoincrement())
  status Boolean @default(true)

  name            String   @db.VarChar(100)
  guardianName    String?  @db.VarChar(100)
  gender          String?
  dateOfBirth     String?
  age             Int
  idCard          String   @unique @db.VarChar(20)
  phoneNumber     String   @unique @db.VarChar(20)
  email           String   @unique @db.VarChar(100)
  address         String?  @db.VarChar(255)
  specialization  String?  @db.VarChar(100)
  qualification   String?  @db.VarChar(100)
  subSpecialities String?  @db.VarChar(100)
  experience      Int
  languages       String?  @db.VarChar(100)
  joinDate        String?
  employmentType  String?
  shiftType       String?
  timingFrom      String?  @db.VarChar(10)
  timingTo        String?  @db.VarChar(10)
  availableDays   String[] @db.VarChar(100)
  maxPatients     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  departmentLinks DoctorDepartment[]
  feeLinks        DoctorProcedureFee[]
  medicalHistory  MedicalHistory[] @relation("MedicalHistoryDoctor")

  @@index([name])
  @@index([specialization])
}

/** ───────── Doctor ↔ Department ───────── */
model DoctorDepartment {
  id           Int @id @default(autoincrement())
  doctorId     Int
  departmentId Int

  doctor     Doctor     @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([doctorId, departmentId])
  @@index([departmentId])
}

/** ───────── Fee Policies ───────── */
model FeePolicy {
  id   Int     @id @default(autoincrement())
  name String  @unique @db.VarChar(100)
  type String?

  fixedAmount        Decimal? @db.Decimal(10, 2)
  doctorPercentage   Decimal? @db.Decimal(5, 2)
  hospitalPercentage Decimal? @db.Decimal(5, 2)

  validFrom DateTime?
  validTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  feeLinks DoctorProcedureFee[]
}

/** ───────── Doctor ↔ Procedure Fee Assignment ───────── */
model DoctorProcedureFee {
  id           Int  @id @default(autoincrement())
  doctorId     Int
  procedureId  Int
  feePolicyId  Int?
  departmentId Int? // optional reference to department

  paymentType String  @db.VarChar(50)
  description String? @db.VarChar(500)
  status      Boolean @default(true)

  doctor     Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  procedure  Procedure   @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  feePolicy  FeePolicy?  @relation(fields: [feePolicyId], references: [id], onDelete: Restrict)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  procedurePrice Decimal? @db.Decimal(10, 2)
  overrideFixedAmount        Decimal? @db.Decimal(10, 2)
  overrideDoctorPercentage   Decimal? @db.Decimal(5, 2)
  overrideHospitalPercentage Decimal? @db.Decimal(5, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([doctorId, procedureId])
  @@index([feePolicyId])
  @@index([departmentId])
}

/** ───────── Patient ───────── */
model Patient {
  id            Int             @id @default(autoincrement())
  patientId     Int             @unique
  name          String
  guardianName  String
  gender        String
  age           Int
  maritalStatus String
  bloodGroup    String
  cnicNumber    String
  phoneNumber   String
  address       String
  createdAt     DateTime        @default(now())

  welfareRecord WelfarePatient?
  medicalHistory MedicalHistory[] @relation("MedicalHistoryPatient")
}

/** ───────── Welfare Patient ───────── */
model WelfarePatient {
  id                 Int       @id @default(autoincrement())
  patientId          Int       @unique
  welfareCategory    String    @db.VarChar(100)
  discountType       String?   @db.VarChar(50)
  discountPercentage Float     @default(0)
  startDate          DateTime?
  endDate            DateTime?
  approvedBy         String?   @db.VarChar(100)
  referredBy         String?   @db.VarChar(100)
  remarks            String?   @db.VarChar(500)

  monthlyIncome    String? @db.VarChar(100)
  sourceOfIncome   String? @db.VarChar(100)
  houseOwnership   String? @db.VarChar(100)
  houseType        String? @db.VarChar(100)
  vehicleOwnership String? @db.VarChar(100)
  familyMembers    Int?
  workingMembers   Int?
  educationLevel   String? @db.VarChar(100)
  financialRemarks String? @db.VarChar(500)

  verificationStatus String?   @db.VarChar(50)
  verifiedBy         String?   @db.VarChar(100)
  verificationDate   DateTime?
  approvalDate       DateTime?
  nextReviewDate     DateTime?

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/** ───────── Medical History ───────── */
model MedicalHistory {
  id              Int        @id @default(autoincrement())
  patientId       Int
  departmentId    Int
  doctorId        Int
  procedureId     Int
  visitDate       DateTime   @default(now())
  fee             Decimal    @db.Decimal(10, 2)
  discount        Float      @default(0)
  finalFee        Decimal    @db.Decimal(10, 2)
  notes           String?    @db.VarChar(500)
  createdAt       DateTime   @default(now())
  createdByUserId Int?

  // Relations
  createdBy       User?      @relation(fields: [createdByUserId], references: [id], name: "MedicalHistoryCreatedBy")
  department      Department @relation(fields: [departmentId], references: [id], name: "MedicalHistoryDepartment")
  doctor          Doctor     @relation(fields: [doctorId], references: [id], name: "MedicalHistoryDoctor")
  patient         Patient    @relation(fields: [patientId], references: [patientId], onDelete: Cascade, name: "MedicalHistoryPatient")
  procedure       Procedure  @relation(fields: [procedureId], references: [id], name: "MedicalHistoryProcedure")
}

/** ───────── Roles ───────── */
model Role {
  id                       Int     @id @default(autoincrement())
  name                     String  @unique
  description              String?
  canManageDepartments     Boolean @default(false)
  canManageDoctors         Boolean @default(false)
  canManagePatients        Boolean @default(false)
  canManageWelfare         Boolean @default(false)
  canManageProcedures      Boolean @default(false)
  canManageFees            Boolean @default(false)
  canViewReports           Boolean @default(false)
  canManagePatientsHistory Boolean @default(false)

  users User[]
}

/** ───────── Users ───────── */
model User {
  id             Int             @id @default(autoincrement())
  name           String
  email          String          @unique
  password       String
  roleId         Int
  role           Role            @relation(fields: [roleId], references: [id], onDelete: Restrict)
  status         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Backrelation for MedicalHistory
  medicalHistoryCreated MedicalHistory[] @relation("MedicalHistoryCreatedBy")
}
