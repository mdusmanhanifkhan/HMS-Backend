generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * —— Departments ——
 */
model Department {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  shortCode   String?  @unique @db.VarChar(10)
  location    String?  @db.VarChar(100)
  description String?  @db.VarChar(500)
  status      Boolean  @default(true)
  timeFrom    String?
  timeTo      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  procedures         Procedure[]
  doctorLinks        DoctorDepartment[]
  DoctorProcedureFee DoctorProcedureFee[]
  MedicalRecord      MedicalRecord[]
  labFees            LabFee[]
  medicalRecordItems MedicalRecordItem[]

  @@index([name])
}

/**
 * —— Procedures ——
 */
model Procedure {
  id           Int        @id @default(autoincrement())
  status       Boolean    @default(true)
  name         String     @db.VarChar(100)
  shortCode    String?    @db.VarChar(10)
  description  String?    @db.VarChar(500)
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  feeLinks           DoctorProcedureFee[]
  MedicalRecord      MedicalRecord[]
  labFees            LabFee[]
  medicalRecordItems MedicalRecordItem[]

  @@unique([departmentId, name])
  @@index([departmentId])
  @@index([name])
}

/**
 * —— Doctor ——
 */
model Doctor {
  id     Int     @id @default(autoincrement())
  status Boolean @default(true)

  name            String   @db.VarChar(100)
  guardianName    String?  @db.VarChar(100)
  gender          String?
  dateOfBirth     String?
  age             Int
  idCard          String   @unique @db.VarChar(20)
  phoneNumber     String   @unique @db.VarChar(20)
  email           String   @unique @db.VarChar(100)
  address         String?  @db.VarChar(255)
  specialization  String?  @db.VarChar(100)
  qualification   String?  @db.VarChar(100)
  subSpecialities String?  @db.VarChar(100)
  experience      Int
  languages       String?  @db.VarChar(100)
  joinDate        String?
  employmentType  String?
  shiftType       String?
  timingFrom      String?  @db.VarChar(10)
  timingTo        String?  @db.VarChar(10)
  availableDays   String[] @db.VarChar(100)
  maxPatients     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  departmentLinks    DoctorDepartment[]
  feeLinks           DoctorProcedureFee[]
  MedicalRecord      MedicalRecord[]
  medicalRecordItems MedicalRecordItem[]

  @@index([name])
  @@index([specialization])
}

/**
 * —— Doctor ↔ Department ——
 */
model DoctorDepartment {
  id           Int @id @default(autoincrement())
  doctorId     Int
  departmentId Int

  doctor     Doctor     @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([doctorId, departmentId])
  @@index([departmentId])
}

/**
 * —— Fee Policies ——
 */
model FeePolicy {
  id   Int     @id @default(autoincrement())
  name String  @unique @db.VarChar(100)
  type String?

  fixedAmount        Decimal? @db.Decimal(10, 2)
  doctorPercentage   Decimal? @db.Decimal(5, 2)
  hospitalPercentage Decimal? @db.Decimal(5, 2)

  validFrom DateTime?
  validTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  feeLinks DoctorProcedureFee[]
}

/**
 * —— Doctor ↔ Procedure Fee Assignment ——
 */
model DoctorProcedureFee {
  id           Int  @id @default(autoincrement())
  doctorId     Int
  procedureId  Int
  feePolicyId  Int?
  departmentId Int? // optional reference to department

  paymentType String  @db.VarChar(50) // 'Share' | 'Fixed' | 'Share + Fixed'
  description String? @db.VarChar(500)
  status      Boolean @default(true)

  // Relations
  doctor     Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  procedure  Procedure   @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  feePolicy  FeePolicy?  @relation(fields: [feePolicyId], references: [id], onDelete: Restrict)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // Procedure price
  procedurePrice Decimal? @db.Decimal(10, 2)

  // Optional overrides
  overrideFixedAmount        Decimal? @db.Decimal(10, 2)
  overrideDoctorPercentage   Decimal? @db.Decimal(5, 2)
  overrideHospitalPercentage Decimal? @db.Decimal(5, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([doctorId, procedureId])
  @@index([feePolicyId])
  @@index([departmentId])
}

model Patient {
  id              Int             @id @default(autoincrement())
  patientId       Int             @unique
  name            String
  guardianName    String
  gender          String
  age             Int
  maritalStatus   String
  bloodGroup      String
  cnicNumber      String
  phoneNumber     String
  address         String
  createdAt       DateTime        @default(now())
  welfareRecord   WelfarePatient?
  MedicalRecord   MedicalRecord[]
  createdByUserId Int?
  createdBy       User?           @relation("PatientCreatedBy", fields: [createdByUserId], references: [id])
}

model WelfarePatient {
  id                 Int       @id @default(autoincrement())
  patientId          Int       @unique
  welfareCategory    String    @db.VarChar(100)
  discountType       String?   @db.VarChar(50)
  discountPercentage Float     @default(0)
  startDate          DateTime?
  endDate            DateTime?
  approvedBy         String?   @db.VarChar(100)
  referredBy         String?   @db.VarChar(100)
  remarks            String?   @db.VarChar(500)

  monthlyIncome    String? @db.VarChar(100)
  sourceOfIncome   String? @db.VarChar(100)
  houseOwnership   String? @db.VarChar(100)
  houseType        String? @db.VarChar(100)
  vehicleOwnership String? @db.VarChar(100)
  familyMembers    Int?
  workingMembers   Int?
  educationLevel   String? @db.VarChar(100)
  financialRemarks String? @db.VarChar(500)

  verificationStatus String?   @db.VarChar(50)
  verifiedBy         String?   @db.VarChar(100)
  verificationDate   DateTime?
  approvalDate       DateTime?
  nextReviewDate     DateTime?

  patient Patient @relation(fields: [patientId], references: [patientId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MedicalRecord {
  id         Int      @id @default(autoincrement())
  patientId  Int
  recordDate DateTime @default(now())

  totalFee Decimal @default(0) @db.Decimal(10, 2)
  discount Float   @default(0)
  finalFee Decimal @db.Decimal(10, 2)
  notes    String? @db.VarChar(500)

  patient Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  items   MedicalRecordItem[]

  createdAt DateTime @default(now())

  // ✅ THIS MUST MATCH DB
  userId       Int
  user         User        @relation(fields: [userId], references: [id])
  department   Department? @relation(fields: [departmentId], references: [id])
  departmentId Int?
  procedure    Procedure?  @relation(fields: [procedureId], references: [id])
  procedureId  Int?
  doctor       Doctor?     @relation(fields: [doctorId], references: [id])
  doctorId     Int?

  @@index([patientId])
}

model MedicalRecordItem {
  id              Int @id @default(autoincrement())
  medicalRecordId Int

  departmentId Int
  doctorId     Int?
  procedureId  Int

  fee      Decimal @db.Decimal(10, 2)
  discount Float   @default(0)
  finalFee Decimal @db.Decimal(10, 2)
  notes    String? @db.VarChar(500)

  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)
  department    Department    @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  doctor        Doctor?       @relation(fields: [doctorId], references: [id], onDelete: Restrict)
  procedure     Procedure     @relation(fields: [procedureId], references: [id], onDelete: Restrict)

  @@index([medicalRecordId])
  @@index([departmentId])
  @@index([doctorId])
}

model Role {
  id                       Int     @id @default(autoincrement())
  name                     String  @unique
  description              String?
  // Permissions (access control)
  canManageDepartments     Boolean @default(false)
  canManageDoctors         Boolean @default(false)
  canManagePatients        Boolean @default(false)
  canManageWelfare         Boolean @default(false)
  canManageProcedures      Boolean @default(false)
  canManageFees            Boolean @default(false)
  canViewReports           Boolean @default(false)
  canManagePatientsHistory Boolean @default(false)
  canManageFinanceReport   Boolean @default(false)
  canManageToken           Boolean @default(false)

  users User[]
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  roleId    Int
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Restrict)
  status    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdPatients Patient[]       @relation("PatientCreatedBy")
  medicalRecords  MedicalRecord[]
}

model LabFee {
  id     Int     @id @default(autoincrement())
  status Boolean @default(true)

  departmentId Int
  procedureId  Int

  price      Decimal @db.Decimal(10, 2)
  discount   Float   @default(0)
  finalPrice Decimal @db.Decimal(10, 2)

  description String? @db.VarChar(500)

  department Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  procedure  Procedure  @relation(fields: [procedureId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([procedureId, departmentId])
  @@index([departmentId])
  @@index([procedureId])
}


model Company {
  id                    Int     @id @default(autoincrement())
  name                  String
  code                  String?
  contactPerson         String?
  phone                 String?
  email                 String?
  drugRegistrationNo    String?
  manufacturingLicenseNo String?
  ntnNumber             String?
  gstNumber             String?
  isActive              Boolean @default(true)
  remarks               String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
